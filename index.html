<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ãƒ«ãƒ³ã‚¦ã‚­ ãƒ•ã‚©ãƒˆã‚«ãƒ¡ãƒ©ï½œé‡£ã‚ŠÃ—æ²–ç¸„ãƒ•ãƒ¬ãƒ¼ãƒ </title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --accent:#22d3ee; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1223,#101827);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
    header{padding:14px 16px;border-bottom:1px solid #243147;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.02em}
    .badge{font-size:12px;background:#0ea5a5;color:#00120f;padding:4px 8px;border-radius:999px}
    main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:rgba(17,24,39,.7);border:1px solid #243147;border-radius:16px;box-shadow:0 6px 30px rgba(0,0,0,.35)}
    .stage{position:relative;aspect-ratio:3/4;width:100%;border-radius:16px;overflow:hidden}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
    canvas.overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    .controls{display:flex;flex-wrap:wrap;gap:12px;padding:12px}
    .controls .spacer{flex:1}
    button, label.button{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1f2937;color:#e5e7eb;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    button:hover, label.button:hover{filter:brightness(1.1)}
    button.primary{background:linear-gradient(180deg,#06b6d4,#0891b2)}
    button.success{background:linear-gradient(180deg,#16a34a,#15803d)}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    input[type=file]{display:none}
    .row{display:flex;gap:12px;flex-wrap:wrap;padding:12px}
    .row .chip{background:#0b1223;border:1px solid #243147;border-radius:999px;padding:8px 12px;cursor:pointer}
    .hint{opacity:.8;font-size:12px;padding:0 12px 12px}
    footer{padding:12px 16px;color:#94a3b8;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“¸ ãƒ«ãƒ³ã‚¦ã‚­ ãƒ•ã‚©ãƒˆã‚«ãƒ¡ãƒ© <span class="badge">ã‚¢ãƒ—ãƒªä¸è¦ãƒ»QRã§èµ·å‹•</span></h1>
    <div style="font-size:12px;opacity:.8">ã€Œæ’®å½±ã€â†’ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§ä¿å­˜ã§ãã¾ã™</div>
  </header>

  <main>
    <section class="card">
      <div class="stage" id="stage">
        <video id="video" playsinline muted></video>
        <!-- ãƒ©ã‚¤ãƒ–ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <canvas id="overlay" class="overlay"></canvas>
      </div>
      <div class="controls">
        <button id="btnStart" class="primary">ğŸ¥ ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
        <button id="btnShot" class="success" disabled>ğŸ“¸ æ’®å½±</button>
        <div class="spacer"></div>
        <button id="modeNone" class="">ãƒ•ãƒ¬ãƒ¼ãƒ ï¼šãªã—</button>
        <button id="modeFrame1" class="">ğŸŒŠ ãƒªã‚¾ãƒ¼ãƒˆA</button>
        <button id="modeFrame2" class="">ğŸ¦ ã‚·ãƒ¼ã‚µãƒ¼B</button>
        <button id="modeFrame3" class="">ğŸ§© PLOWã¨å†™çœŸ</button>
        <label class="button" for="customImg">ğŸ–¼ï¸ ã‚«ã‚¹ã‚¿ãƒ ç”»åƒ</label>
        <input type="file" id="customImg" accept="image/*" />
      </div>
      <div class="row" id="tips">
        <div class="chip">ğŸ”Š ã‚·ãƒ£ãƒƒã‚¿ãƒ¼éŸ³ã¯é³´ã‚Šã¾ã›ã‚“</div>
        <div class="chip">ğŸ”’ ç”»åƒã¯ç«¯æœ«å†…ã§å‡¦ç†ï¼ˆã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã—ï¼‰</div>
        <div class="chip">ğŸ“¶ HTTPSã§ã®å…¬é–‹æ¨å¥¨ï¼ˆiOS Safariè¦ä»¶ï¼‰</div>
      </div>
      <div class="hint">â€» ã‚«ãƒ¡ãƒ©ãŒæ˜ ã‚‰ãªã„å ´åˆï¼šSafari/Chromeã®ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ONã«ã—ã€å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>
    </section>


  </main>

  <footer>Â© 2025 ãƒ«ãƒ³ã‚¦ã‚­ãƒãƒ¼ã‚±ãƒƒãƒˆ / ãƒ—ãƒ©ã‚¦çµŒé¨“å‹æ•™è‚²å¡¾ æ’®å½±ãƒ–ãƒ¼ã‚¹ï¼ˆãƒ‡ãƒ¢ï¼‰</footer>

<script>
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const stage = document.getElementById('stage');
  const btnStart = document.getElementById('btnStart');
  const btnShot = document.getElementById('btnShot');
  const modeNone = document.getElementById('modeNone');
  const modeFrame1 = document.getElementById('modeFrame1');
  const modeFrame2 = document.getElementById('modeFrame2');
  const modeFrame3 = document.getElementById('modeFrame3');
  const fileInput = document.getElementById('customImg');

  let stream = null;
  let lastBlobUrl = null;
  let customImage = null; // HTMLImageElement or null
  // PNGãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒ
  let frame1 = null; // ãƒªã‚¾ãƒ¼ãƒˆA
  let frame2 = null; // ã‚·ãƒ¼ã‚µãƒ¼B
  let frame3 = null; // PLOWã¨å†™çœŸ
  let mode = 'frame1';

  function pad2(n){ return String(n).padStart(2,'0'); }
  function makeFilename(mode){
    const d = new Date();
    const y = d.getFullYear(), m = pad2(d.getMonth()+1), day = pad2(d.getDate());
    const h = pad2(d.getHours()), mi = pad2(d.getMinutes()), s = pad2(d.getSeconds());
    const labelMap = { frame1: 'resortA', frame2: 'shisaB', frame3: 'plow', none: 'noframe' };
    const label = labelMap[mode] || 'other';
    return `runuki-${y}${m}${day}-${h}${mi}${s}-${label}.jpg`;
  }

  // ã‚µã‚¤ã‚ºèª¿æ•´
  function fitOverlayToVideo(){
    const rect = stage.getBoundingClientRect();
    overlay.width = rect.width; overlay.height = rect.height;
    drawOverlay();
  }
  new ResizeObserver(fitOverlayToVideo).observe(stage);

  // ã‚«ãƒ¡ãƒ©é–‹å§‹
  btnStart.addEventListener('click', async () => {
    try {
      if(stream){ return; }
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream; await video.play();
      btnShot.disabled = false;
      fitOverlayToVideo();
    } catch(e){
      alert('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚„HTTPSã‚’ã”ç¢ºèªãã ã•ã„ã€‚\n' + e);
    }
  });

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  function setMode(m){ mode = m; drawOverlay(); }
  modeNone.onclick = () => setMode('none');
  modeFrame1.onclick = () => setMode('frame1');
  modeFrame2.onclick = () => setMode('frame2');
  modeFrame3.onclick = () => setMode('frame3');

  // ã‚«ã‚¹ã‚¿ãƒ ç”»åƒã®èª­ã¿è¾¼ã¿
  fileInput.addEventListener('change', (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const img = new Image();
    img.onload = ()=>{ customImage = img; drawOverlay(); };
    img.src = URL.createObjectURL(f);
  });

  // ãƒ©ã‚¤ãƒ–ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»
  function drawOverlay(){
    const ctx = overlay.getContext('2d');
    const w = overlay.width, h = overlay.height;
    ctx.clearRect(0,0,w,h);

    if(mode === 'frame1' && frame1){
      drawImageFrame(ctx, frame1, w, h);
    } else if(mode === 'frame2' && frame2){
      drawImageFrame(ctx, frame2, w, h);
    } else if(mode === 'frame3' && frame3){
      drawImageFrame(ctx, frame3, w, h);
    }

    if(customImage){
      const cw = Math.min(w, h) * 0.45;
      const ch = cw * (customImage.height / customImage.width);
      ctx.globalAlpha = 0.95;
      ctx.drawImage(customImage, w - cw - 12, h - ch - 12, cw, ch);
      ctx.globalAlpha = 1;
    }
  }

  function drawImageFrame(ctx, img, w, h){
    // ç”»åƒæ¯”ç‡ã‚’ä¿ã£ãŸã¾ã¾å…¨é¢ã«ãƒ•ã‚£ãƒƒãƒˆ
    const ratio = Math.min(w / img.width, h / img.height);
    const iw = img.width * ratio;
    const ih = img.height * ratio;
    const x = (w - iw) / 2;
    const y = (h - ih) / 2;
    ctx.drawImage(img, x, y, iw, ih);
  }

  // æ’®å½±ï¼ˆè‡ªå‹•ä¿å­˜ONã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ç„¡ã—ï¼‰
  btnShot.addEventListener('click', async ()=>{
    if(!stream || video.readyState < 2){ alert('ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚'); return; }

    // ã‚­ãƒ£ãƒ—ãƒãƒ£ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å‹•ç”»ã‚µã‚¤ã‚ºã«
    const vw = video.videoWidth, vh = video.videoHeight;
    const canvas = document.createElement('canvas');
    canvas.width = vw; canvas.height = vh;
    const ctx = canvas.getContext('2d');
    // æ˜ åƒ
    ctx.drawImage(video, 0, 0, vw, vh);
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå‹•ç”»ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ãƒªãƒ‰ãƒ­ãƒ¼ï¼‰
    if(mode === 'frame1' && frame1){
      drawImageFrame(ctx, frame1, vw, vh);
    } else if(mode === 'frame2' && frame2){
      drawImageFrame(ctx, frame2, vw, vh);
    } else if(mode === 'frame3' && frame3){
      drawImageFrame(ctx, frame3, vw, vh);
    }
    if(customImage){
      const cw = Math.min(vw, vh) * 0.45;
      const ch = cw * (customImage.height / customImage.width);
      ctx.globalAlpha = 0.95;
      ctx.drawImage(customImage, vw - cw - 24, vh - ch - 24, cw, ch);
      ctx.globalAlpha = 1;
    }

    canvas.toBlob((blob)=>{
      if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
      const url = URL.createObjectURL(blob);
      lastBlobUrl = url;
      const fname = makeFilename(mode);
      triggerDownload(url, fname); // â˜…æ’®å½±ã”ã¨ã«è‡ªå‹•ä¿å­˜
    }, 'image/jpeg', 0.92);
  });

  // è‡ªå‹•ä¿å­˜ï¼ˆiOSå¯¾ç­–ã¤ãï¼‰: å¼•æ•°ã§URLã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å—ã‘å–ã‚‹
  function triggerDownload(url, name){
    if(!url) return;
    const a = document.createElement('a');
    a.href = url;
    if('download' in HTMLAnchorElement.prototype){
      // Android/PCãªã© downloadå±æ€§ãŒåŠ¹ãå ´åˆ
      a.download = name || makeFilename(mode);
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } else {
      // iOS Safariãªã©ï¼šæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ã¦ã€Œå†™çœŸã«ä¿å­˜ã€
      window.open(url, '_blank');
    }
  }

  // ç”»åƒãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
  function preload(src){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload  = ()=> { console.log('loaded:', src); resolve(img); };
      img.onerror = ()=> { console.warn('failed:', src); reject(new Error('ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“: ' + src)); };
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
      img.src = src + '?v=' + Date.now();
    });
  }

  (async ()=>{
    try { frame1 = await preload('images/frame1.png'); } catch(e){}
    try { frame2 = await preload('images/frame2.png'); } catch(e){}
    try { frame3 = await preload('images/frame3.png'); } catch(e){}
    fitOverlayToVideo();
    setMode('frame3'); // èµ·å‹•æ™‚ã«PLOWã¨å†™çœŸã‚’è¡¨ç¤º
  })();
</script>

</body>
</html>
