<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ルンウキ フォトカメラ｜釣り×沖縄フレーム</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --accent:#22d3ee; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1223,#101827);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
    header{padding:14px 16px;border-bottom:1px solid #243147;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.02em}
    .badge{font-size:12px;background:#0ea5a5;color:#00120f;padding:4px 8px;border-radius:999px}
    main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:rgba(17,24,39,.7);border:1px solid #243147;border-radius:16px;box-shadow:0 6px 30px rgba(0,0,0,.35)}
    .stage{position:relative;aspect-ratio:3/4;width:100%;border-radius:16px;overflow:hidden}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
    canvas.overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    .controls{display:flex;flex-wrap:wrap;gap:12px;padding:12px}
    .controls .spacer{flex:1}
    button, label.button{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1f2937;color:#e5e7eb;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    button:hover, label.button:hover{filter:brightness(1.1)}
    button.primary{background:linear-gradient(180deg,#06b6d4,#0891b2)}
    button.success{background:linear-gradient(180deg,#16a34a,#15803d)}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    input[type=file]{display:none}
    .row{display:flex;gap:12px;flex-wrap:wrap;padding:12px}
    .row .chip{background:#0b1223;border:1px solid #243147;border-radius:999px;padding:8px 12px;cursor:pointer}
    .hint{opacity:.8;font-size:12px;padding:0 12px 12px}
    footer{padding:12px 16px;color:#94a3b8;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>📸 ルンウキ フォトカメラ <span class="badge">アプリ不要・QRで起動</span></h1>
    <div style="font-size:12px;opacity:.8">「撮影」→「ダウンロード」で保存できます</div>
  </header>

  <main>
    <section class="card">
      <div class="stage" id="stage">
        <video id="video" playsinline muted></video>
        <!-- ライブ用オーバーレイ -->
        <canvas id="overlay" class="overlay"></canvas>
      </div>
      <div class="controls">
        <button id="btnStart" class="primary">🎥 カメラ開始</button>
        <button id="btnShot" class="success" disabled>📸 撮影</button>
        <button id="btnDownload" class>⬇️ ダウンロード</button>
        <div class="spacer"></div>
        <button id="modeNone" class="">フレーム：なし</button>
        <button id="modeFish" class="">🐟 おさかな</button>
        <button id="modeOki" class="">🏝️ 沖縄</button>
        <button id="modeFrame1" class="">🌊 リゾートA</button>
        <button id="modeFrame2" class="">🦁 シーサーB</button>
        <label class="button" for="customImg">🖼️ カスタム画像</label>
        <input type="file" id="customImg" accept="image/*" />
      </div>
      <div class="row" id="tips">
        <div class="chip">🔊 シャッター音は鳴りません</div>
        <div class="chip">🔒 画像は端末内で処理（サーバー送信なし）</div>
        <div class="chip">📶 HTTPSでの公開推奨（iOS Safari要件）</div>
      </div>
      <div class="hint">※ カメラが映らない場合：Safari/Chromeのカメラ許可をONにし、再読み込みしてください。</div>
    </section>

    <section class="card" style="padding:12px">
      <div class="hint">使い方：この1ファイルを公開し、URLをQR化して会場に掲示するだけ。参加者のスマホで開くとカメラが起動し、<b>「おさかな」や「沖縄」フレーム</b>を重ねて撮影できます。オリジナルのPNGを「カスタム画像」で読み込み可能です。</div>
    </section>
  </main>

  <footer>© 2025 ルンウキマーケット / 教育ベンチャー撮影ブース（デモ）</footer>

  <script>
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const stage = document.getElementById('stage');
  const btnStart = document.getElementById('btnStart');
  const btnShot = document.getElementById('btnShot');
  const btnDownload = document.getElementById('btnDownload');
  const modeNone = document.getElementById('modeNone');
  const modeFish = document.getElementById('modeFish');
  const modeOki  = document.getElementById('modeOki');
  const modeFrame1 = document.getElementById('modeFrame1');
  const modeFrame2 = document.getElementById('modeFrame2');
  const fileInput = document.getElementById('customImg');

  let stream = null;
  let lastBlobUrl = null;
  let customImage = null; // HTMLImageElement or null
  // 追加: PNGフレームの画像
  let frame1 = null; // リゾートA
  let frame2 = null; // シーサーB
  let mode = 'fish';

  // サイズ調整
  function fitOverlayToVideo(){
    const rect = stage.getBoundingClientRect();
    overlay.width = rect.width; overlay.height = rect.height;
    drawOverlay();
  }
  new ResizeObserver(fitOverlayToVideo).observe(stage);

  // カメラ開始
  btnStart.addEventListener('click', async () => {
    try {
      if(stream){ return; }
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream; await video.play();
      btnShot.disabled = false;
      fitOverlayToVideo();
    } catch(e){
      alert('カメラが起動できませんでした。権限やHTTPSをご確認ください。' + '\n' + e);
    }
  });

  // モード切替
  function setMode(m){ mode = m; drawOverlay(); }
  modeNone.onclick = () => setMode('none');
  modeFish.onclick = () => setMode('fish');
  modeOki.onclick  = () => setMode('oki');
  modeFrame1.onclick = () => setMode('frame1');
  modeFrame2.onclick = () => setMode('frame2');

  // カスタム画像の読み込み
  fileInput.addEventListener('change', (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const img = new Image();
    img.onload = ()=>{ customImage = img; drawOverlay(); };
    img.src = URL.createObjectURL(f);
  });

  // ライブ用オーバーレイ描画
  function drawOverlay(){
    const ctx = overlay.getContext('2d');
    const w = overlay.width, h = overlay.height;
    ctx.clearRect(0,0,w,h);

    if(mode === 'fish'){
      drawFishOverlay(ctx, w, h, 0.9);
    } else if(mode === 'oki'){
      drawOkinawaOverlay(ctx, w, h, 0.9);
    } else if(mode === 'frame1' && frame1){
      drawImageFrame(ctx, frame1, w, h);
    } else if(mode === 'frame2' && frame2){
      drawImageFrame(ctx, frame2, w, h);
    }

    if(customImage){ // 右下にリサイズして配置
      const cw = Math.min(w, h) * 0.45;
      const ch = cw * (customImage.height / customImage.width);
      ctx.globalAlpha = 0.95;
      ctx.drawImage(customImage, w - cw - 12, h - ch - 12, cw, ch);
      ctx.globalAlpha = 1;
    }
  }

  function drawImageFrame(ctx, img, w, h){
    // 画像比率を保ったまま全面にフィット
    const ratio = Math.min(w / img.width, h / img.height);
    const iw = img.width * ratio;
    const ih = img.height * ratio;
    const x = (w - iw) / 2;
    const y = (h - ih) / 2;
    ctx.drawImage(img, x, y, iw, ih);
  }

  function drawFishOverlay(ctx, w, h, opacity=1){
    ctx.save(); ctx.globalAlpha = opacity;
    ctx.lineWidth = Math.max(6, Math.min(w,h)*0.012);
    ctx.strokeStyle = '#22d3ee';
    ctx.strokeRect(6,6,w-12,h-12);
    for(let i=0;i<20;i++){
      const x = Math.random()*w; const y = Math.random()*h; const r = Math.random()*8+4;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.stroke();
    }
    ctx.font = Math.max(20, Math.min(w,h)*0.05) + 'px serif';
    for(let x=0;x<w; x+= Math.max(60, w*0.12)){
      ctx.fillText('🐟', x+10, Math.max(30, h*0.15));
      ctx.fillText('🐠', x+30, Math.max(60, h*0.28));
    }
    ctx.restore();
  }

  function drawOkinawaOverlay(ctx, w, h, opacity=1){
    ctx.save(); ctx.globalAlpha = opacity;
    const grad = ctx.createLinearGradient(0,0,0,h);
    grad.addColorStop(0,'rgba(59,130,246,.25)');
    grad.addColorStop(1,'rgba(250,204,21,.10)');
    ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
    ctx.fillStyle = 'rgba(245, 200, 80, .25)';
    ctx.beginPath(); ctx.moveTo(0,h*0.82); ctx.quadraticCurveTo(w*0.4,h*0.78, w,h*0.88); ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fill();
    ctx.font = Math.max(24, Math.min(w,h)*0.06) + 'px serif';
    ctx.fillText('🌴', 16, h*0.85);
    ctx.fillText('🌺', w-48, h*0.20);
    ctx.fillText('🦀', w*0.15, h*0.9);
    ctx.fillText('🌀', w*0.75, h*0.2);
    ctx.restore();
  }

  // 撮影
  btnShot.addEventListener('click', async ()=>{
    if(!stream || video.readyState < 2){ alert('カメラを開始してください。'); return; }
    const vw = video.videoWidth, vh = video.videoHeight;
    const canvas = document.createElement('canvas');
    canvas.width = vw; canvas.height = vh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, vw, vh);
    if(mode === 'fish'){
      drawFishOverlay(ctx, vw, vh, 0.95);
    } else if(mode === 'oki'){
      drawOkinawaOverlay(ctx, vw, vh, 0.95);
    } else if(mode === 'frame1' && frame1){
      drawImageFrame(ctx, frame1, vw, vh);
    } else if(mode === 'frame2' && frame2){
      drawImageFrame(ctx, frame2, vw, vh);
    }
    if(customImage){
      const cw = Math.min(vw, vh) * 0.45;
      const ch = cw * (customImage.height / customImage.width);
      ctx.globalAlpha = 0.95;
      ctx.drawImage(customImage, vw - cw - 24, vh - ch - 24, cw, ch);
      ctx.globalAlpha = 1;
    }

    canvas.toBlob((blob)=>{
      if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
      lastBlobUrl = URL.createObjectURL(blob);
      btnDownload.dataset.href = lastBlobUrl;
      btnDownload.classList.add('primary');
      btnDownload.textContent = '⬇️ ダウンロード（撮影済み）';
    }, 'image/jpeg', 0.92);
  });

  function triggerDownload(){
    const url = btnDownload.dataset.href; if(!url){ return; }
    const a = document.createElement('a'); a.href = url; a.download = 'runuki-photo.jpg'; a.click();
  }

  btnDownload.addEventListener('click', ()=>{ triggerDownload(); });

  // 画像フレームのプリロード
  function preload(src){
    return new Promise((resolve)=>{ const img = new Image(); img.onload=()=>resolve(img); img.src=src; });
  }
  (async ()=>{
    try { frame1 = await preload('images/frame1.png'); } catch(e){}
    try { frame2 = await preload('images/frame2.png'); } catch(e){}
    fitOverlayToVideo(); setMode('frame1');
  })();
  </script>
</body>
</html>
